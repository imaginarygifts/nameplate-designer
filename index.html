<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nameplate Designer</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins&family=Great+Vibes&family=Playfair+Display&family=Cormorant&family=Dancing+Script&family=Montserrat&family=Cinzel&family=Libre+Baskerville&family=Lora&family=Abril+Fatface&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f2f2f2;}
#controls{
  background:#fff;padding:10px;display:flex;gap:10px;
  justify-content:center;align-items:center;flex-wrap:wrap;
}
select,button{padding:6px 10px;font-size:14px;cursor:pointer;}
.icon-btn{font-size:18px;border:1px solid #ccc;border-radius:6px;background:#fff;}
#colorPanel{
  display:none;background:#fff;padding:8px;margin:5px auto;
  width:fit-content;border-radius:6px;
}
.color-swatch{
  width:24px;height:24px;border-radius:50%;
  display:inline-block;margin:4px;border:1px solid #aaa;
  cursor:pointer;
}
canvas{
  background:#fff;border:2px solid #333;
  display:block;margin:15px auto;
  touch-action:none; /* ðŸ”¥ REQUIRED FOR MOBILE */
}
</style>
</head>

<body>

<div id="controls">
  <select onchange="addShape(this.value)">
    <option value="">Choose Shape</option>
    <option value="rect">Rectangle</option>
    <option value="rounded">Rounded</option>
    <option value="pill">Pill</option>
    <option value="circle">Circle</option>
    <option value="oval">Oval</option>
    <option value="arch">Arch</option>
    <option value="diamond">Diamond</option>
    <option value="hexagon">Hexagon</option>
    <option value="shield">Shield</option>
    <option value="vertical">Vertical</option>
  </select>

  <select onchange="changeFont(this.value)">
    <option value="">Select Font</option>
    <option>Poppins</option><option>Great Vibes</option>
    <option>Playfair Display</option><option>Cormorant</option>
    <option>Dancing Script</option><option>Montserrat</option>
    <option>Cinzel</option><option>Libre Baskerville</option>
    <option>Lora</option><option>Abril Fatface</option>
  </select>

  <button onclick="addText()">Add Text</button>
  <button class="icon-btn" onclick="undo()">âŸ²</button>
  <button class="icon-btn" onclick="redo()">âŸ³</button>
  <button id="colorBtn" onclick="toggleColorPanel()" style="display:none;">ðŸŽ¨ Color</button>
  <button onclick="exportJPG()">Save JPG</button>
</div>

<div id="colorPanel"></div>
<canvas id="canvas" width="800" height="400"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const colorPanel = document.getElementById("colorPanel");
const colorBtn = document.getElementById("colorBtn");

let objects=[], selected=null;
let action=null, sx=0, sy=0, startAngle=0;
let undoStack=[], redoStack=[];
let lastTap = 0;

const ICON_R=10, ICON_OFFSET=18;

/* ---------- MOBILE COORDINATES ---------- */
function getPos(evt){
  const rect = canvas.getBoundingClientRect();
  const touch = evt.touches ? evt.touches[0] : evt;
  return {
    x: (touch.clientX - rect.left) * (canvas.width / rect.width),
    y: (touch.clientY - rect.top) * (canvas.height / rect.height)
  };
}

/* ---------- STATE ---------- */
function saveState(){ undoStack.push(JSON.stringify(objects)); redoStack=[]; }
function undo(){ if(!undoStack.length) return; redoStack.push(JSON.stringify(objects)); objects=JSON.parse(undoStack.pop()); selected=null; hideColor(); draw(); }
function redo(){ if(!redoStack.length) return; undoStack.push(JSON.stringify(objects)); objects=JSON.parse(redoStack.pop()); selected=null; hideColor(); draw(); }

/* ---------- HIT TEST ---------- */
function dist(x1,y1,x2,y2){return Math.hypot(x1-x2,y1-y2);}
function hit(mx,my,o){
  if(dist(mx,my,o.x-ICON_OFFSET,o.y-ICON_OFFSET)<ICON_R) return "delete";
  if(dist(mx,my,o.x+o.w+ICON_OFFSET,o.y-ICON_OFFSET)<ICON_R) return "rotate";
  if(dist(mx,my,o.x+o.w+ICON_OFFSET,o.y+o.h+ICON_OFFSET)<ICON_R) return "resize";
  if(mx>o.x&&mx<o.x+o.w&&my>o.y&&my<o.y+o.h) return "move";
  return null;
}

/* ---------- POINTER HANDLERS ---------- */
function pointerDown(evt){
  evt.preventDefault();
  const {x,y} = getPos(evt);
  selected=null; action=null; hideColor();

  const now = Date.now();
  if(now - lastTap < 300 && selected && selected.type==="text"){
    editText();
    return;
  }
  lastTap = now;

  for(let i=objects.length-1;i>=0;i--){
    const o=objects[i];
    const h=hit(x,y,o);
    if(h){
      selected=o; action=h;
      sx=x; sy=y;
      startAngle=Math.atan2(y-(o.y+o.h/2),x-(o.x+o.w/2))-o.rotation;
      if(h==="delete"){
        saveState();
        objects=objects.filter(v=>v!==o);
        selected=null;
      }
      showColor();
      break;
    }
  }
  draw();
}

function pointerMove(evt){
  if(!selected) return;
  evt.preventDefault();
  const {x,y} = getPos(evt);

  if(action==="move"){
    selected.x+=x-sx; selected.y+=y-sy;
    sx=x; sy=y;
  }
  if(action==="resize"){
    selected.w+=x-sx; selected.h+=y-sy;
    if(selected.type==="text") selected.fontSize=Math.max(14,selected.h*0.6);
    sx=x; sy=y;
  }
  if(action==="rotate"){
    selected.rotation=Math.atan2(y-(selected.y+selected.h/2),x-(selected.x+selected.w/2))-startAngle;
  }
  draw();
}

function pointerUp(){
  if(action) saveState();
  action=null;
}

/* ---------- EVENTS ---------- */
canvas.addEventListener("mousedown",pointerDown);
canvas.addEventListener("mousemove",pointerMove);
canvas.addEventListener("mouseup",pointerUp);

canvas.addEventListener("touchstart",pointerDown,{passive:false});
canvas.addEventListener("touchmove",pointerMove,{passive:false});
canvas.addEventListener("touchend",pointerUp);

/* ---------- TEXT ---------- */
function editText(){
  const t=prompt("Edit text",selected.text);
  if(t){
    saveState();
    selected.text=t;
    ctx.font=`${selected.fontSize}px ${selected.font}`;
    selected.w=ctx.measureText(t).width+30;
    draw();
  }
}

/* ---------- COLOR ---------- */
function showColor(){ colorBtn.style.display="inline-block"; }
function hideColor(){ colorBtn.style.display="none"; colorPanel.style.display="none"; }

/* ---------- PLACEHOLDER DRAW (KEEP YOUR EXISTING DRAW LOGIC BELOW) ---------- */
function draw(){ /* unchanged â€“ your existing draw code stays here */ }

/* ---------- EXPORT ---------- */
function exportJPG(){
  const a=document.createElement("a");
  a.download="design.jpg";
  a.href=canvas.toDataURL("image/jpeg",1);
  a.click();
}
</script>
</body>
</html>
